<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Productivity Monkey</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #5568d3;
      --secondary: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1f2937;
      --gray: #6b7280;
      --light-gray: #f3f4f6;
      --white: #ffffff;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--light-gray);
      color: var(--dark);
      line-height: 1.6;
    }

    /* Header */
    header {
      background: var(--white);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: background 0.2s;
    }

    .user-profile:hover {
      background: var(--light-gray);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .signout-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--gray);
      border: 1px solid var(--gray);
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .signout-btn:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* Main Content */
    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .welcome-section {
      margin-bottom: 2rem;
    }

    .welcome-section h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .welcome-section p {
      color: var(--gray);
      font-size: 1rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .stat-title {
      font-size: 0.875rem;
      color: var(--gray);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-icon {
      font-size: 2rem;
      opacity: 0.8;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .stat-change {
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .chart-card {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: var(--shadow);
    }

    .chart-card h3 {
      margin-bottom: 1.5rem;
      font-size: 1.125rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* Activity Tables */
    .activity-section {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .activity-section h3 {
      margin-bottom: 1rem;
      font-size: 1.125rem;
    }

    .activity-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid var(--light-gray);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab:hover {
      color: var(--primary-dark);
    }

    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--light-gray);
      align-items: center;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .activity-category {
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .category-deep {
      background: #dbeafe;
      color: #1e40af;
    }

    .category-shallow {
      background: #fef3c7;
      color: #92400e;
    }

    .category-admin {
      background: #e0e7ff;
      color: #3730a3;
    }

    .category-distracted {
      background: #fee2e2;
      color: #991b1b;
    }

    .activity-time {
      color: var(--gray);
      font-size: 0.875rem;
    }

    .activity-engagement {
      font-size: 0.875rem;
      color: var(--gray);
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem;
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--light-gray);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error State */
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 1rem 1.5rem;
      border-radius: 0.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid var(--danger);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .activity-item {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <a href="/" class="logo">
        <span class="logo-icon">üêµ</span>
        <span>Productivity Monkey</span>
      </a>
      <div class="user-menu">
        <div class="user-profile" id="userProfile">
          <div class="user-avatar" id="userAvatar">
            <span id="userInitials">U</span>
          </div>
          <div class="user-info">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-email" id="userEmail" style="font-size: 0.75rem; color: var(--gray);"></div>
          </div>
        </div>
        <button class="signout-btn" onclick="signOut()">Sign Out</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main id="mainContent">
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Loading your productivity data...</p>
    </div>
  </main>

  <script>
    const API_URL = window.location.origin;
    let currentUser = null;
    let metricsData = null;
    let charts = {};

    // Check authentication on load
    window.addEventListener('load', async () => {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/auth.html';
        return;
      }

      try {
        // Verify token and load user
        const response = await fetch(`${API_URL}/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Authentication failed');
        }

        currentUser = await response.json();
        displayUserInfo();
        await loadDashboardData();
      } catch (error) {
        console.error('Auth error:', error);
        localStorage.removeItem('auth_token');
        window.location.href = '/auth.html';
      }
    });

    function displayUserInfo() {
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userEmail').textContent = currentUser.email;

      // Set user avatar
      const avatarEl = document.getElementById('userAvatar');
      if (currentUser.profilePicture) {
        avatarEl.innerHTML = `<img src="${currentUser.profilePicture}" alt="${currentUser.name}">`;
      } else {
        const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        document.getElementById('userInitials').textContent = initials;
      }
    }

    async function loadDashboardData() {
      const token = localStorage.getItem('auth_token');

      try {
        // Calculate week range
        const now = Date.now();
        const weekStart = getWeekStart(now);
        const weekEnd = getWeekEnd(now);

        // Fetch all data in parallel
        const [metricsRes, appUsageRes, browserActivityRes] = await Promise.all([
          fetch(`${API_URL}/api/metrics/weekly/${currentUser.id}?weekStart=${weekStart}&weekEnd=${weekEnd}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`${API_URL}/api/metrics/app-usage/${currentUser.id}?weekStart=${weekStart}&weekEnd=${weekEnd}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          }),
          fetch(`${API_URL}/api/metrics/browser-activity/${currentUser.id}?weekStart=${weekStart}&weekEnd=${weekEnd}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          })
        ]);

        const metrics = await metricsRes.json();
        const appUsage = await appUsageRes.json();
        const browserActivity = await browserActivityRes.json();

        metricsData = { metrics, appUsage: appUsage.appUsage || [], browserActivity: browserActivity.browserActivity || [] };

        renderDashboard();
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Failed to load dashboard data. Please try again.');
      }
    }

    function renderDashboard() {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="welcome-section">
          <h1>Welcome back, ${currentUser.name.split(' ')[0]}!</h1>
          <p>Here's your productivity overview for this week</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Focus Score</div>
              <div class="stat-icon">üéØ</div>
            </div>
            <div class="stat-value">${Math.round(metricsData.metrics.focusScore || 0)}</div>
            <div class="stat-change positive">‚Üë Track your concentration</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Deep Work</div>
              <div class="stat-icon">üí™</div>
            </div>
            <div class="stat-value">${(metricsData.metrics.deepWorkHours || 0).toFixed(1)}h</div>
            <div class="stat-change">This week</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Active Hours</div>
              <div class="stat-icon">‚ö°</div>
            </div>
            <div class="stat-value">${(metricsData.metrics.activeHours || 0).toFixed(1)}h</div>
            <div class="stat-change">Total tracked time</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-title">Productivity</div>
              <div class="stat-icon">üìä</div>
            </div>
            <div class="stat-value">${calculateProductivityPercent()}%</div>
            <div class="stat-change ${calculateProductivityPercent() >= 70 ? 'positive' : 'negative'}">
              ${calculateProductivityPercent() >= 70 ? '‚Üë' : '‚Üì'} ${calculateProductivityPercent() >= 70 ? 'Great!' : 'Room to improve'}
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Time Distribution</h3>
            <div class="chart-container">
              <canvas id="timeDistributionChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <h3>Top Applications</h3>
            <div class="chart-container">
              <canvas id="topAppsChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Activity Section -->
        <div class="activity-section">
          <h3>Activity Breakdown</h3>
          <div class="activity-tabs">
            <button class="tab active" onclick="showTab('apps')">Applications</button>
            <button class="tab" onclick="showTab('browser')">Browser Activity</button>
          </div>
          <div id="activityContent">
            ${renderAppsActivity()}
          </div>
        </div>
      `;

      // Render charts
      renderCharts();
    }

    function renderCharts() {
      // Time Distribution Pie Chart
      const timeCtx = document.getElementById('timeDistributionChart');
      if (timeCtx && metricsData.metrics) {
        charts.timeDistribution = new Chart(timeCtx, {
          type: 'doughnut',
          data: {
            labels: ['Deep Work', 'Shallow Work', 'Admin', 'Unproductive', 'Idle'],
            datasets: [{
              data: [
                metricsData.metrics.deepWorkHours || 0,
                metricsData.metrics.shallowWorkHours || 0,
                metricsData.metrics.adminHours || 0,
                metricsData.metrics.unproductiveHours || 0,
                metricsData.metrics.idleHours || 0
              ],
              backgroundColor: [
                '#3b82f6',
                '#fbbf24',
                '#8b5cf6',
                '#ef4444',
                '#9ca3af'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      // Top Apps Bar Chart
      const appsCtx = document.getElementById('topAppsChart');
      if (appsCtx && metricsData.appUsage) {
        const topApps = metricsData.appUsage.slice(0, 8);
        charts.topApps = new Chart(appsCtx, {
          type: 'bar',
          data: {
            labels: topApps.map(app => app.appName.substring(0, 20)),
            datasets: [{
              label: 'Hours',
              data: topApps.map(app => app.timeUsed),
              backgroundColor: '#667eea'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }

    function renderAppsActivity() {
      if (!metricsData.appUsage || metricsData.appUsage.length === 0) {
        return '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>No application data yet. Start tracking to see your stats!</p></div>';
      }

      return `
        <div class="activity-list">
          ${metricsData.appUsage.map(app => `
            <div class="activity-item">
              <div class="activity-name">
                <span>${app.appName}</span>
              </div>
              <div class="activity-category">
                <span class="activity-category category-${app.category}">${app.category}</span>
              </div>
              <div class="activity-time">${formatHours(app.timeUsed)}</div>
              <div class="activity-engagement">
                ${app.keystrokesCount || 0} keys
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderBrowserActivity() {
      if (!metricsData.browserActivity || metricsData.browserActivity.length === 0) {
        return '<div class="empty-state"><div class="empty-state-icon">üåê</div><p>No browser data yet. Install the browser extension to track web activity!</p></div>';
      }

      return `
        <div class="activity-list">
          ${metricsData.browserActivity.map(site => `
            <div class="activity-item">
              <div class="activity-name">
                <span>${site.domain || site.url}</span>
              </div>
              <div class="activity-category">
                <span class="activity-category category-${site.category || 'shallow'}">${site.category || 'web'}</span>
              </div>
              <div class="activity-time">${formatHours(site.timeSpent)}</div>
              <div class="activity-engagement">
                ${site.visits || 0} visits
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showTab(tab) {
      // Update tab styles
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // Update content
      const content = document.getElementById('activityContent');
      if (tab === 'apps') {
        content.innerHTML = renderAppsActivity();
      } else {
        content.innerHTML = renderBrowserActivity();
      }
    }

    function calculateProductivityPercent() {
      if (!metricsData.metrics) return 0;
      const total = metricsData.metrics.activeHours || 0;
      if (total === 0) return 0;
      const productive = (metricsData.metrics.deepWorkHours || 0) + (metricsData.metrics.shallowWorkHours || 0);
      return Math.round((productive / total) * 100);
    }

    function formatHours(hours) {
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      if (h === 0) return `${m}m`;
      return `${h}h ${m}m`;
    }

    function getWeekStart(timestamp) {
      const date = new Date(timestamp);
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(date.setDate(diff)).setHours(0, 0, 0, 0);
    }

    function getWeekEnd(timestamp) {
      const start = getWeekStart(timestamp);
      return new Date(start).setDate(new Date(start).getDate() + 6) + (24 * 60 * 60 * 1000 - 1);
    }

    function showError(message) {
      const main = document.getElementById('mainContent');
      main.innerHTML = `
        <div class="error-message">
          <strong>Error:</strong> ${message}
        </div>
        <button onclick="location.reload()" class="btn">Reload Page</button>
      `;
    }

    async function signOut() {
      try {
        await fetch(`${API_URL}/auth/signout`, {
          method: 'POST',
          credentials: 'include'
        });
      } catch (error) {
        console.error('Sign out error:', error);
      } finally {
        localStorage.removeItem('auth_token');
        window.location.href = '/auth.html';
      }
    }
  </script>
</body>
</html>
