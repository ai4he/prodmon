<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productivity Monkey - Server Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
    }

    .user-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      padding: 8px 16px;
      border: 1px solid #d2d2d7;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #0071e3;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .stat-label {
      font-size: 13px;
      color: #86868b;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .stat-unit {
      font-size: 16px;
      color: #86868b;
    }

    .section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .app-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .app-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f5f5f7;
      border-radius: 8px;
    }

    .app-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-name {
      font-weight: 500;
    }

    .app-category {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .category-deep { background: #d1f0e0; color: #067647; }
    .category-shallow { background: #ffeaa7; color: #d63031; }
    .category-admin { background: #dfe6e9; color: #2d3436; }
    .category-distracted { background: #fab1a0; color: #d63031; }
    .category-idle { background: #dfe4ea; color: #57606f; }

    .app-time {
      font-size: 16px;
      font-weight: 600;
      color: #1d1d1f;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #86868b;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0071e3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .browser-activity {
      max-height: 400px;
      overflow-y: auto;
    }

    .website-item {
      padding: 12px;
      background: #f5f5f7;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .website-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .website-url {
      font-size: 12px;
      color: #0071e3;
      text-decoration: none;
    }

    .website-url:hover {
      text-decoration: underline;
    }

    .website-stats {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 12px;
      color: #86868b;
    }

    .error {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      color: #c53030;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üêí Productivity Monkey</h1>
      <div class="user-selector">
        <label for="userSelect">View User:</label>
        <select id="userSelect">
          <option value="">Loading users...</option>
        </select>
        <button onclick="refreshData()" style="padding: 8px 16px; background: #0071e3; color: white; border: none; border-radius: 8px; cursor: pointer;">Refresh</button>
      </div>
    </header>

    <div id="errorContainer"></div>
    <div id="loadingContainer" class="loading">
      <div class="spinner"></div>
      <div>Loading dashboard data...</div>
    </div>

    <div id="dashboardContainer" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Hours</div>
          <div class="stat-value"><span id="totalHours">0</span><span class="stat-unit">h</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Deep Work</div>
          <div class="stat-value"><span id="deepWork">0</span><span class="stat-unit">h</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Focus Score</div>
          <div class="stat-value"><span id="focusScore">0</span><span class="stat-unit">/100</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Hours</div>
          <div class="stat-value"><span id="activeHours">0</span><span class="stat-unit">h</span></div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">üìä Top Applications</div>
        <div id="appList" class="app-list"></div>
      </div>

      <div class="section">
        <div class="section-title">üåê Browser Activity</div>
        <div id="browserList" class="browser-activity"></div>
      </div>
    </div>
  </div>

  <script>
    let currentUserId = null;
    const API_BASE = window.location.origin;

    // Initialize
    async function init() {
      await loadUsers();
    }

    // Load all users
    async function loadUsers() {
      try {
        const response = await fetch(`${API_BASE}/api/users`);
        const data = await response.json();

        const userSelect = document.getElementById('userSelect');
        userSelect.innerHTML = '<option value="">Select a user...</option>';

        data.users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name} (${user.team})`;
          userSelect.appendChild(option);
        });

        // Select first user by default
        if (data.users.length > 0) {
          currentUserId = data.users[0].id;
          userSelect.value = currentUserId;
          await loadDashboard();
        }
      } catch (error) {
        showError('Failed to load users: ' + error.message);
      }
    }

    // Load dashboard for selected user
    async function loadDashboard() {
      const userSelect = document.getElementById('userSelect');
      currentUserId = userSelect.value;

      if (!currentUserId) return;

      showLoading();

      try {
        // Get current week
        const now = Date.now();
        const weekStart = getWeekStart(now);
        const weekEnd = getWeekEnd(now);

        // Fetch data
        const [metricsRes, appUsageRes, browserRes] = await Promise.all([
          fetch(`${API_BASE}/api/metrics/weekly/${currentUserId}?weekStart=${weekStart}&weekEnd=${weekEnd}`),
          fetch(`${API_BASE}/api/metrics/app-usage/${currentUserId}?weekStart=${weekStart}&weekEnd=${weekEnd}`),
          fetch(`${API_BASE}/api/metrics/browser-activity/${currentUserId}?weekStart=${weekStart}&weekEnd=${weekEnd}`)
        ]);

        const metrics = await metricsRes.json();
        const appUsage = await appUsageRes.json();
        const browserActivity = await browserRes.json();

        // Update UI
        updateStats(metrics);
        updateAppList(appUsage.appUsage || []);
        updateBrowserList(browserActivity.browserActivity || []);

        hideLoading();
      } catch (error) {
        showError('Failed to load dashboard: ' + error.message);
        hideLoading();
      }
    }

    // Update statistics
    function updateStats(metrics) {
      document.getElementById('totalHours').textContent = metrics.totalHours.toFixed(1);
      document.getElementById('deepWork').textContent = metrics.deepWorkHours.toFixed(1);
      document.getElementById('focusScore').textContent = Math.round(metrics.focusScore);
      document.getElementById('activeHours').textContent = metrics.activeHours.toFixed(1);
    }

    // Update app list
    function updateAppList(apps) {
      const appList = document.getElementById('appList');
      appList.innerHTML = '';

      apps.slice(0, 10).forEach(app => {
        const item = document.createElement('div');
        item.className = 'app-item';
        item.innerHTML = `
          <div class="app-info">
            <span class="app-name">${app.appName}</span>
            <span class="app-category category-${app.category}">${app.category}</span>
          </div>
          <span class="app-time">${app.timeUsed.toFixed(1)}h</span>
        `;
        appList.appendChild(item);
      });
    }

    // Update browser activity
    function updateBrowserList(sites) {
      const browserList = document.getElementById('browserList');
      browserList.innerHTML = '';

      sites.slice(0, 15).forEach(site => {
        const item = document.createElement('div');
        item.className = 'website-item';

        let domain = 'Unknown';
        try {
          const url = new URL(site.url);
          domain = url.hostname;
        } catch (e) {
          domain = site.url;
        }

        item.innerHTML = `
          <div class="website-title">
            ${site.title || domain}
            <span class="app-category category-${site.category}">${site.category}</span>
          </div>
          <a href="${site.url}" class="website-url" target="_blank">${site.url}</a>
          <div class="website-stats">
            <span>‚è±Ô∏è ${site.timeSpent.toFixed(1)}h</span>
            <span>üî¢ ${site.visitCount} visits</span>
            <span>‚å®Ô∏è ${site.keystrokesCount} keystrokes</span>
            <span>üñ±Ô∏è ${site.mouseMovements} clicks</span>
          </div>
        `;
        browserList.appendChild(item);
      });
    }

    // Utility functions
    function getWeekStart(timestamp) {
      const date = new Date(timestamp);
      const day = date.getDay();
      const diff = date.getDate() - day;
      return new Date(date.setDate(diff)).setHours(0, 0, 0, 0);
    }

    function getWeekEnd(timestamp) {
      const date = new Date(timestamp);
      const day = date.getDay();
      const diff = date.getDate() + (6 - day);
      return new Date(date.setDate(diff)).setHours(23, 59, 59, 999);
    }

    function showLoading() {
      document.getElementById('loadingContainer').style.display = 'block';
      document.getElementById('dashboardContainer').style.display = 'none';
      document.getElementById('errorContainer').innerHTML = '';
    }

    function hideLoading() {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('dashboardContainer').style.display = 'block';
    }

    function showError(message) {
      document.getElementById('errorContainer').innerHTML = `
        <div class="error">${message}</div>
      `;
    }

    function refreshData() {
      loadDashboard();
    }

    // Handle user selection change
    document.getElementById('userSelect').addEventListener('change', loadDashboard);

    // Initialize on load
    init();
  </script>
</body>
</html>
